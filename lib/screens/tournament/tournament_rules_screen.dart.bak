import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import '../../config/app_theme.dart';

class TournamentRulesScreen extends StatefulWidget {
  final Map<String, dynamic>? initialRules;
  const TournamentRulesScreen({super.key, this.initialRules});
  @override
  State<TournamentRulesScreen> createState() => _TournamentRulesScreenState();
}

class _TournamentRulesScreenState extends State<TournamentRulesScreen> {
  int _prelimRounds = 1;
  int _prelimSets = 2;
  bool _prelimDeuce = false;
  int _prelimDeuceCap = 17;

  bool _useMatchPoints = true;
  int _scoreWin20 = 10;
  int _scoreWin11 = 7;
  int _scoreDraw = 4;
  int _scoreLose11 = 2;
  int _scoreLose02 = 0;

  bool _hasFinal = true;
  int _finalSets = 3;
  bool _finalDeuce = true;
  int _finalDeuceCap = 17;
  bool _thirdPlace = true;
  bool _loserRevival = false;
  String _finalFormat = '順位別複数';

  bool _uniformRequired = false;
  bool _snsVideoAllowed = true;
  String _lunchBreak = 'なし';

  @override
  void initState() {
    super.initState();
    if (widget.initialRules != null) _loadRules(widget.initialRules!);
  }

  void _loadRules(Map<String, dynamic> r) {
    final p = r['preliminary'] as Map<String, dynamic>? ?? {};
    final f = r['final'] as Map<String, dynamic>? ?? {};
    final s = r['scoring'] as Map<String, dynamic>? ?? {};
    final o = r['other'] as Map<String, dynamic>? ?? {};
    setState(() {
      _prelimRounds = p['rounds'] ?? 1;
      _prelimSets = p['sets'] ?? 2;
      _prelimDeuce = p['deuce'] ?? false;
      _prelimDeuceCap = p['deuceCap'] ?? 17;
      _useMatchPoints = s['enabled'] ?? true;
      _scoreWin20 = s['win20'] ?? 10;
      _scoreWin11 = s['win11'] ?? 7;
      _scoreDraw = s['draw'] ?? 4;
      _scoreLose11 = s['lose11'] ?? 2;
      _scoreLose02 = s['lose02'] ?? 0;
      _hasFinal = f['enabled'] ?? true;
      _finalSets = f['sets'] ?? 3;
      _finalDeuce = f['deuce'] ?? true;
      _finalDeuceCap = f['deuceCap'] ?? 17;
      _thirdPlace = f['thirdPlace'] ?? true;
      _loserRevival = f['loserRevival'] ?? false;
      _finalFormat = f['format'] ?? '順位別複数';
      _uniformRequired = o['uniformRequired'] ?? false;
      _snsVideoAllowed = o['snsVideoAllowed'] ?? true;
      _lunchBreak = o['lunchBreak'] ?? 'なし';
    });
  }

  Map<String, dynamic> _buildRules() {
    return {
      'preliminary': {
        'rounds': _prelimRounds, 'sets': _prelimSets,
        'points': 15, 'deuce': _prelimDeuce, 'deuceCap': _prelimDeuceCap,
      },
      'scoring': {
        'enabled': _useMatchPoints,
        'win20': _scoreWin20, 'win11': _scoreWin11,
        'draw': _scoreDraw, 'lose11': _scoreLose11, 'lose02': _scoreLose02,
      },
      'final': {
        'enabled': _hasFinal, 'sets': _finalSets,
        'points': 15, 'deuce': _finalDeuce, 'deuceCap': _finalDeuceCap,
        'thirdPlace': _thirdPlace, 'loserRevival': _loserRevival,
        'format': _finalFormat,
      },
      'management': {
        'entryType': 'チーム', 'maxSubs': 0,
        'courtChange': false, 'scoreMethod': 'アプリ入力',
      },
      'other': {
        'uniformRequired': _uniformRequired, 'snsVideoAllowed': _snsVideoAllowed,
        'lunchBreak': _lunchBreak,
      },
    };
  }

  // テンプレート保存
  Future<void> _saveTemplate() async {
    final nameCtrl = TextEditingController();
    final name = await showDialog<String>(context: context, builder: (ctx) {
      return AlertDialog(
        title: const Text('テンプレート名'),
        content: TextField(controller: nameCtrl, decoration: const InputDecoration(hintText: '例: かびるんるんかっぷ設定')),
        actions: [
          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('キャンセル')),
          TextButton(onPressed: () => Navigator.pop(ctx, nameCtrl.text.trim()), child: const Text('保存')),
        ],
      );
    });
    if (name == null || name.isEmpty) return;
    final uid = FirebaseAuth.instance.currentUser?.uid;
    if (uid == null) return;
    await FirebaseFirestore.instance.collection('users').doc(uid)
      .collection('ruleTemplates').add({
        'name': name,
        'rules': _buildRules(),
        'createdAt': FieldValue.serverTimestamp(),
      });
    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('「$name」を保存しました'), backgroundColor: AppTheme.success));
    }
  }

  // テンプレート読み込み
  Future<void> _loadTemplate() async {
    final uid = FirebaseAuth.instance.currentUser?.uid;
    if (uid == null) return;
    final snap = await FirebaseFirestore.instance.collection('users').doc(uid)
      .collection('ruleTemplates').orderBy('createdAt', descending: true).get();
    if (snap.docs.isEmpty) {
      if (mounted) ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('保存済みテンプレートがありません')));
      return;
    }
    if (!mounted) return;
    final selected = await showDialog<Map<String, dynamic>>(context: context, builder: (ctx) {
      return AlertDialog(
        title: const Text('テンプレートを選択'),
        content: SizedBox(width: double.maxFinite, child: ListView.builder(
          shrinkWrap: true,
          itemCount: snap.docs.length,
          itemBuilder: (_, i) {
            final data = snap.docs[i].data();
            final docId = snap.docs[i].id;
            return ListTile(
              title: Text(data['name'] ?? '無名'),
              trailing: IconButton(
                icon: const Icon(Icons.delete, size: 20, color: Colors.red),
                onPressed: () async {
                  await FirebaseFirestore.instance.collection('users').doc(uid)
                    .collection('ruleTemplates').doc(docId).delete();
                  Navigator.pop(ctx);
                  _loadTemplate();
                },
              ),
              onTap: () => Navigator.pop(ctx, data['rules'] as Map<String, dynamic>?),
            );
          },
        )),
        actions: [TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('キャンセル'))],
      );
    });
    if (selected != null) _loadRules(selected);
  }

  static const Color _prelimColor = Color(0xFF4CAF50);
  static const Color _scoringColor = Color(0xFF4CAF50);
  static const Color _finalColor = Color(0xFF2196F3);
  static const Color _otherColor = Color(0xFF9E9E9E);

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        title: const Text('ルール設定', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 18)),
        backgroundColor: AppTheme.primaryColor, foregroundColor: Colors.white, elevation: 0,
        leading: IconButton(icon: const Icon(Icons.arrow_back), onPressed: () => Navigator.pop(context, _buildRules())),
        actions: [
          IconButton(icon: const Icon(Icons.folder_open), tooltip: '過去の設定を読込', onPressed: _loadTemplate),
          IconButton(icon: const Icon(Icons.save), tooltip: 'この設定を保存', onPressed: _saveTemplate),
        ],
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Column(crossAxisAlignment: CrossAxisAlignment.start, children: [
          _sectionHeader('予選ルール', Icons.sports_volleyball, _prelimColor),
          const SizedBox(height: 12),
          _choiceRow('予選ラウンド数', [1, 2], _prelimRounds, (v) => setState(() => _prelimRounds = v), _prelimColor),
          _choiceRow('セット数', [1, 2, 3], _prelimSets, (v) => setState(() => _prelimSets = v), _prelimColor),
          _switchRow('ジュース（デュース）', _prelimDeuce, (v) => setState(() => _prelimDeuce = v), _prelimColor),
          if (_prelimDeuce)
            _choiceRow('ジュース上限', [17, 21, 25], _prelimDeuceCap, (v) => setState(() => _prelimDeuceCap = v), _prelimColor),

          const SizedBox(height: 24),
          _sectionHeader('勝ち点制', Icons.emoji_events, _scoringColor),
          const SizedBox(height: 12),
          _switchRow('勝ち点制を使用する', _useMatchPoints, (v) => setState(() => _useMatchPoints = v), _scoringColor),
          if (!_useMatchPoints)
            const Padding(padding: EdgeInsets.only(left: 8, top: 4),
              child: Text('※ 勝敗数のみで順位を決定します', style: TextStyle(fontSize: 12, color: AppTheme.textSecondary))),
          if (_useMatchPoints) ...[
            const SizedBox(height: 8),
            _pointRow('2-0 勝利', _scoreWin20, (v) => setState(() => _scoreWin20 = v)),
            _pointRow('1-1 得失点差勝ち', _scoreWin11, (v) => setState(() => _scoreWin11 = v)),
            _pointRow('1-1 同点（引分）', _scoreDraw, (v) => setState(() => _scoreDraw = v)),
            _pointRow('1-1 得失点差負け', _scoreLose11, (v) => setState(() => _scoreLose11 = v)),
            _pointRow('0-2 敗北', _scoreLose02, (v) => setState(() => _scoreLose02 = v)),
          ],

          const SizedBox(height: 24),
          _sectionHeader('決勝トーナメント', Icons.account_tree, _finalColor),
          const SizedBox(height: 12),
          _switchRow('決勝トーナメントを行う', _hasFinal, (v) => setState(() => _hasFinal = v), _finalColor),
          if (_hasFinal) ...[
            const SizedBox(height: 8),
            const Text('トーナメント方式', style: TextStyle(fontSize: 14, fontWeight: FontWeight.w600)),
            const SizedBox(height: 8),
            _formatCard('順位別複数', '上位・中位・下位など\n順位帯ごとにトーナメント', Icons.view_column,
              _finalFormat == '順位別複数', () => setState(() => _finalFormat = '順位別複数'), _finalColor),
            const SizedBox(height: 8),
            _formatCard('全チーム一本', '全チームで1つの\nトーナメントを実施', Icons.account_tree,
              _finalFormat == '全チーム一本', () => setState(() => _finalFormat = '全チーム一本'), _finalColor),
            const SizedBox(height: 12),
            _choiceRow('セット数', [2, 3], _finalSets, (v) => setState(() => _finalSets = v), _finalColor),
            _switchRow('ジュース', _finalDeuce, (v) => setState(() => _finalDeuce = v), _finalColor),
            if (_finalDeuce)
              _choiceRow('ジュース上限', [17, 21, 25], _finalDeuceCap, (v) => setState(() => _finalDeuceCap = v), _finalColor),
            _switchRow('3位決定戦', _thirdPlace, (v) => setState(() => _thirdPlace = v), _finalColor),
            _switchRow('敗者復活戦', _loserRevival, (v) => setState(() => _loserRevival = v), _finalColor),
          ],

          const SizedBox(height: 24),
          _sectionHeader('その他設定', Icons.settings, _otherColor),
          const SizedBox(height: 12),
          _switchRow('ユニフォーム番号必須', _uniformRequired, (v) => setState(() => _uniformRequired = v), _otherColor),
          _switchRow('SNS動画投稿許可', _snsVideoAllowed, (v) => setState(() => _snsVideoAllowed = v), _otherColor),
          _stringChoiceRow('昼休憩', ['なし', '30分', '45分', '60分'], _lunchBreak, (v) => setState(() => _lunchBreak = v)),

          const SizedBox(height: 32),
          SizedBox(width: double.infinity, child: ElevatedButton(
            onPressed: () => Navigator.pop(context, _buildRules()),
            style: ElevatedButton.styleFrom(
              backgroundColor: AppTheme.primaryColor, foregroundColor: Colors.white,
              padding: const EdgeInsets.symmetric(vertical: 16),
              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12))),
            child: const Text('この設定で保存', style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
          )),
          const SizedBox(height: 20),
        ]),
      ),
    );
  }

  Widget _sectionHeader(String title, IconData icon, Color color) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),
      decoration: BoxDecoration(
        color: color.withOpacity(0.1),
        borderRadius: BorderRadius.circular(10)),
      child: Row(children: [
        Icon(icon, size: 20, color: color),
        const SizedBox(width: 8),
        Text(title, style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold, color: color)),
      ]),
    );
  }

  Widget _choiceRow(String label, List<int> options, int selected, ValueChanged<int> onChanged, Color color) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8),
      child: Row(children: [
        Expanded(flex: 4, child: Text(label, style: const TextStyle(fontSize: 14))),
        Expanded(flex: 6, child: Wrap(spacing: 6, children: options.map((o) {
          final sel = o == selected;
          return GestureDetector(onTap: () => onChanged(o),
            child: Container(
              padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 8),
              decoration: BoxDecoration(
                color: sel ? color : Colors.grey[100],
                borderRadius: BorderRadius.circular(8)),
              child: Text('$o', style: TextStyle(fontSize: 14, fontWeight: FontWeight.w600,
                color: sel ? Colors.white : AppTheme.textSecondary)),
            ));
        }).toList())),
      ]),
    );
  }

  Widget _stringChoiceRow(String label, List<String> options, String selected, ValueChanged<String> onChanged) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8),
      child: Row(children: [
        Expanded(flex: 4, child: Text(label, style: const TextStyle(fontSize: 14))),
        Expanded(flex: 6, child: Wrap(spacing: 6, children: options.map((o) {
          final sel = o == selected;
          return GestureDetector(onTap: () => onChanged(o),
            child: Container(
              padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
              decoration: BoxDecoration(
                color: sel ? _otherColor : Colors.grey[100],
                borderRadius: BorderRadius.circular(8)),
              child: Text(o, style: TextStyle(fontSize: 13, fontWeight: FontWeight.w600,
                color: sel ? Colors.white : AppTheme.textSecondary)),
            ));
        }).toList())),
      ]),
    );
  }

  Widget _switchRow(String label, bool value, ValueChanged<bool> onChanged, Color color) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 4),
      child: Row(children: [
        Expanded(child: Text(label, style: const TextStyle(fontSize: 14))),
        Switch(value: value, onChanged: onChanged, activeColor: color),
      ]),
    );
  }

  Widget _pointRow(String label, int value, ValueChanged<int> onChanged) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 6),
      child: Row(children: [
        Expanded(flex: 5, child: Text(label, style: const TextStyle(fontSize: 14))),
        Row(mainAxisSize: MainAxisSize.min, children: [
          GestureDetector(onTap: () { if (value > 0) onChanged(value - 1); },
            child: Container(padding: const EdgeInsets.all(6),
              decoration: BoxDecoration(color: Colors.grey[200], borderRadius: BorderRadius.circular(6)),
              child: const Icon(Icons.remove, size: 18))),
          Padding(padding: const EdgeInsets.symmetric(horizontal: 16),
            child: Text('$value pt', style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold))),
          GestureDetector(onTap: () { if (value < 20) onChanged(value + 1); },
            child: Container(padding: const EdgeInsets.all(6),
              decoration: BoxDecoration(color: _scoringColor.withOpacity(0.15), borderRadius: BorderRadius.circular(6)),
              child: Icon(Icons.add, size: 18, color: _scoringColor))),
        ]),
      ]),
    );
  }

  Widget _formatCard(String title, String desc, IconData icon, bool selected, VoidCallback onTap, Color color) {
    return GestureDetector(onTap: onTap,
      child: Container(
        padding: const EdgeInsets.all(14),
        decoration: BoxDecoration(
          color: selected ? color.withOpacity(0.08) : Colors.grey[50],
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: selected ? color : Colors.grey[200]!, width: selected ? 2 : 1)),
        child: Row(children: [
          Icon(icon, size: 28, color: selected ? color : AppTheme.textSecondary),
          const SizedBox(width: 12),
          Expanded(child: Column(crossAxisAlignment: CrossAxisAlignment.start, children: [
            Text(title, style: TextStyle(fontSize: 15, fontWeight: FontWeight.bold,
              color: selected ? color : AppTheme.textPrimary)),
            const SizedBox(height: 4),
            Text(desc, style: const TextStyle(fontSize: 12, color: AppTheme.textSecondary)),
          ])),
          if (selected) Icon(Icons.check_circle, color: color),
        ]),
      ),
    );
  }
}
